<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read Aloud Activity - French (Strict Version)</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
.container { width: 100%; max-width: 800px; padding: 30px; background-color: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
.title { font-size: 36px; font-weight: bold; margin-bottom: 10px; color: #333; }
#counter { font-size: 22px; font-weight: bold; color: #666; margin-bottom: 25px; }
.hide { display: none; }
#sentenceDisplay { font-size: 28px; font-weight: bold; color: #007bff; margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-radius: 12px; line-height: 1.5; }
button { font-size: 18px; padding: 12px 25px; margin: 10px 5px; cursor: pointer; border-radius: 10px; border: 2px solid #ccc; background-color: #f8f9fa; color: #333; transition: all 0.2s ease-in-out; font-weight: bold; min-width: 180px; }
button:hover { background-color: #e2e6ea; border-color: #b3b9be; transform: translateY(-2px); }
button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
#recordButton.recording { background-color: #dc3545; border-color: #c82333; color: white; }
#feedback, #transcriptOutput { font-size: 20px; font-weight: bold; min-height: 24px; margin-top: 15px; }
#transcriptOutput { color: #333; font-style: normal; }
.correct-word { color: green; font-weight: bold; }
.wrong-word { color: red; font-weight: bold; cursor: help; }
</style>
</head>
<body>
<div class="container">
  <div class="title">Read Aloud - French</div>
  <div id="counter">Loading...</div>
  <div id="sentenceDisplay">Please wait for sentences to load.</div>
  <button id="recordButton" onclick="toggleRecording()">Start Recording</button>
  <div id="feedback"></div>
  <div id="transcriptOutput"></div>
  <div>
    <button id="nextButton" class="hide" onclick="nextSentence()">Next</button>
  </div>
</div>

<script>
let currentIndex = 0;
let allSentences = [];
let exerciseSentences = [];
let recognition;
let isRecording = false;
let recognitionTimeout;

// Speech recognition setup
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  document.querySelector('.title').textContent = "⚠️ Browser Not Supported";
  document.getElementById('sentenceDisplay').textContent = "Your browser does not support speech recognition.";
  document.getElementById('recordButton').disabled = true;
} else {
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.lang = 'fr-FR';

  recognition.onresult = handleRecognitionResult;
  recognition.onerror = handleRecognitionError;
  recognition.onend = () => {
    clearTimeout(recognitionTimeout);
    isRecording = false;
    document.getElementById('recordButton').textContent = 'Start Recording';
    document.getElementById('recordButton').classList.remove('recording');
  };
}

// Load Google Sheet
const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');
if (sheetUrl) {
    Papa.parse(sheetUrl, {
        download: true, header: true, skipEmptyLines: true,
        complete: (results) => {
            allSentences = results.data
                .map(row => row["French sentences"]?.trim())
                .filter(Boolean)
                .map(sentence => ({ sentence }));
            if (allSentences.length > 0) {
                initialize();
            } else {
                document.getElementById('counter').textContent = "No sentences found. Check your sheet.";
            }
        },
        error: () => { document.getElementById('counter').textContent = "Could not load data from the sheet."; }
    });
} else {
    document.querySelector('.title').textContent = "⚠️ Error";
    document.getElementById('counter').textContent = "No Google Sheet URL provided.";
}

// --- UTILITIES ---
function normalizeApostrophes(text){ return text.replace(/’/g,"'"); }
function levenshteinDistance(a,b){const m=Array(b.length+1).fill(null).map(()=>Array(a.length+1).fill(null));for(let i=0;i<=a.length;i++){m[0][i]=i}for(let j=0;j<=b.length;j++){m[j][0]=j}for(let j=1;j<=b.length;j++){for(let i=1;i<=a.length;i++){const c=a[i-1]===b[j-1]?0:1;m[j][i]=Math.min(m[j][i-1]+1,m[j-1][i]+1,m[j-1][i-1]+c)}}return m[b.length][a.length]}
function phoneticEncode(word){return word.toLowerCase().replace(/[aeiouy]/g,"").replace(/ph/g,"f").replace(/ck/g,"k").replace(/sh/g,"ch").replace(/[^a-z]/g,"");}

// REVISED: Stricter normalization for more precise checking.
// This version ONLY normalizes accents, forcing a much more accurate match.
function normalizeFrench(word) {
    let w = word.toLowerCase().trim();
    
    // Normalize accents but leave all consonants and vowels otherwise intact.
    w = w.replace(/[àâ]/g, "a");
    w = w.replace(/[éèêë]/g, "e");
    w = w.replace(/[ïî]/g, "i");
    w = w.replace(/[ô]/g, "o");
    w = w.replace(/[ùûü]/g, "u");
    w = w.replace(/ç/g, "c");
    w = w.replace(/œ/g, "oe");
    
    return w;
}

function playWord(word){
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang = 'fr-FR';
    utterance.rate = 0.9;
    window.speechSynthesis.speak(utterance);
  }
}

// --- APP LOGIC ---
function initialize(){
  exerciseSentences = [...allSentences].sort(() => 0.5 - Math.random()).slice(0, 10);
  currentIndex = 0;
  updateUI();
}

function updateUI(){
  document.getElementById('counter').textContent = `Sentence ${currentIndex + 1} / ${exerciseSentences.length}`;
  document.getElementById('sentenceDisplay').textContent = exerciseSentences[currentIndex].sentence;
  document.getElementById('feedback').textContent = '';
  document.getElementById('transcriptOutput').innerHTML = '';
  document.getElementById('recordButton').classList.remove('hide');
  document.getElementById('nextButton').classList.add('hide');
}

function toggleRecording(){
  if (!isRecording && recognition) {
    try {
      recognition.start();
      isRecording = true;
      document.getElementById('recordButton').textContent = 'Recording...';
      document.getElementById('recordButton').classList.add('recording');
      document.getElementById('feedback').textContent = 'Listening...';
      recognitionTimeout = setTimeout(() => {
        if (isRecording) {
          recognition.stop();
          document.getElementById('feedback').textContent = "Recording timed out. Try again.";
          document.getElementById('feedback').style.color = 'red';
        }
      }, 15000);
    } catch(e) { console.error(e); isRecording = false; }
  }
}

function handleRecognitionResult(event){
  checkPronunciation(event.results[0][0].transcript);
}

function handleRecognitionError(event){
  let msg = `Error: ${event.error}`;
  if (event.error === 'not-allowed' || event.error === 'service-not-allowed') msg = "Microphone access denied.";
  else if (event.error === 'no-speech') msg = "No speech detected. Try again.";
  document.getElementById('feedback').textContent = msg;
  document.getElementById('feedback').style.color = 'red';
}

// REVISED: Hover hint removed for a cleaner UI.
function checkPronunciation(transcript) {
    const feedbackEl = document.getElementById('feedback');
    const transcriptOutput = document.getElementById('transcriptOutput');
    const correctSentence = exerciseSentences[currentIndex].sentence;

    const punctuation = /[.,?!;:"-]/g;
    const finalTranscript = normalizeApostrophes(transcript).replace(punctuation, '').toLowerCase().trim();
    const finalCorrect = normalizeApostrophes(correctSentence).replace(punctuation, '').toLowerCase().trim();

    const transcriptWords = finalTranscript.split(/\s+/).filter(Boolean);
    const correctWords = finalCorrect.split(/\s+/).filter(Boolean);

    let matches = 0;
    let highlightedSentence = [];
    const usedTranscriptWords = new Array(transcriptWords.length).fill(false);
    let searchFromIndex = 0;

    correctWords.forEach((word) => {
        const targetWord = normalizeFrench(word);
        let foundMatch = false;
        let bestMatchIndex = -1;

        for (let i = searchFromIndex; i < transcriptWords.length; i++) {
            if (!usedTranscriptWords[i]) {
                const learnerWord = normalizeFrench(transcriptWords[i]);
                let isMatch = false;

                if (targetWord.length <= 2) isMatch = (targetWord === learnerWord);
                else if (targetWord.length <= 4) isMatch = (levenshteinDistance(learnerWord, targetWord) <= 1);
                else {
                    const dist = levenshteinDistance(learnerWord, targetWord);
                    const distThreshold = Math.max(1, Math.floor(targetWord.length / 4));
                    isMatch = (dist <= distThreshold || phoneticEncode(learnerWord) === phoneticEncode(targetWord));
                }

                if (isMatch) {
                    bestMatchIndex = i;
                    break;
                }
            }
        }
        
        if (bestMatchIndex !== -1) {
            matches++;
            highlightedSentence.push(`<span class="correct-word">${word}</span>`);
            usedTranscriptWords[bestMatchIndex] = true;
            searchFromIndex = bestMatchIndex + 1;
        } else {
            // Hint removed as requested.
            highlightedSentence.push(`<span class="wrong-word"
                onmouseenter="playWord('${word.replace(/'/g, "\\'")}')"
                onmouseleave="window.speechSynthesis.cancel()">${word}</span>`);
            
            searchFromIndex++;
        }
    });

    const similarity = (matches / correctWords.length) * 100;
    const threshold = correctWords.length > 5 ? 65 : 70;

    feedbackEl.textContent = `Pronunciation score: ${similarity.toFixed(0)}%`;
    feedbackEl.style.color = similarity >= threshold ? 'green' : 'darkorange';
    transcriptOutput.innerHTML = highlightedSentence.join(" ");

    if (similarity >= threshold) {
        document.getElementById('recordButton').classList.add('hide');
        if (currentIndex < exerciseSentences.length - 1) {
            document.getElementById('nextButton').classList.remove('hide');
        } else {
            feedbackEl.textContent = '🎉 Congratulations! You have completed the exercise.';
        }
    }
}

function nextSentence(){
  currentIndex++;
  updateUI();
}
</script>
</body>
</html>
