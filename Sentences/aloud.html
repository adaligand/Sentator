<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Read Aloud Activity - French</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; background-color: #f4f4f9; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 20px; box-sizing: border-box; }
  .container { width: 100%; max-width: 800px; padding: 30px; background-color: #fff; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
  .title { font-size: 36px; font-weight: bold; margin-bottom: 10px; color: #333; }
  #counter { font-size: 22px; font-weight: bold; color: #666; margin-bottom: 25px; }
  .hide { display: none; }
  #sentenceDisplay { font-size: 28px; font-weight: bold; color: #007bff; margin: 30px 0; padding: 20px; background-color: #f8f9fa; border-radius: 12px; line-height: 1.5; }
  button { font-size: 18px; padding: 12px 25px; margin: 10px 5px; cursor: pointer; border-radius: 10px; border: 2px solid #ccc; background-color: #f8f9fa; color: #333; transition: all 0.2s ease-in-out; font-weight: bold; min-width: 180px; }
  button:hover { background-color: #e2e6ea; border-color: #b3b9be; transform: translateY(-2px); }
  button:disabled { background-color: #ccc; cursor: not-allowed; transform: none; }
  #recordButton.recording { background-color: #dc3545; border-color: #c82333; color: white; }
  #feedback, #transcriptOutput { font-size: 20px; font-weight: bold; min-height: 24px; margin-top: 15px; }
  #transcriptOutput { color: #333; font-style: normal; }
  .correct-word { color: green; font-weight: bold; }
  .wrong-word { color: red; font-weight: bold; cursor: help; }
</style>
</head>
<body>
<div class="container">
  <div class="title">Read Aloud - French</div>
  <div id="counter">Loading...</div>
  <div id="sentenceDisplay">Please wait for sentences to load.</div>
  <button id="recordButton" onclick="toggleRecording()">Start Recording</button>
  <div id="feedback"></div>
  <div id="transcriptOutput"></div>
  <div>
    <button id="nextButton" class="hide" onclick="nextSentence()">Next</button>
  </div>
</div>

<script>
let currentIndex = 0;
let allSentences = [];
let exerciseSentences = [];
let recognition;
let isRecording = false;

// Speech recognition setup
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
if (!SpeechRecognition) {
  document.querySelector('.title').textContent = "⚠️ Browser Not Supported";
  document.getElementById('sentenceDisplay').textContent = "Your browser does not support speech recognition.";
  document.getElementById('recordButton').disabled = true;
} else {
  recognition = new SpeechRecognition();
  recognition.continuous = false;
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  recognition.lang = 'fr-FR';

  recognition.onresult = handleRecognitionResult;
  recognition.onerror = handleRecognitionError;
  recognition.onend = () => {
    isRecording = false;
    document.getElementById('recordButton').textContent = 'Start Recording';
    document.getElementById('recordButton').classList.remove('recording');
  };
}

// Load Google Sheet
const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
  document.querySelector('.title').textContent = "⚠️ Error";
  document.getElementById('counter').textContent = "No Google Sheet URL provided.";
} else {
  Papa.parse(sheetUrl, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: function(results) {
      results.data.forEach(row => {
        if (row["French sentences"] && row["French sentences"].trim()) {
          allSentences.push({ sentence: row["French sentences"].trim() });
        }
      });
      if (allSentences.length === 0) {
        document.querySelector('.title').textContent = "⚠️ Error";
        document.getElementById('counter').textContent = "No sentences found. Check your sheet.";
        return;
      }
      initialize();
    },
    error: function() {
      document.querySelector('.title').textContent = "⚠️ Error";
      document.getElementById('counter').textContent = "Could not load data from the sheet.";
    }
  });
}

// Utilities
function normalizeApostrophes(text) { return text.replace(/’/g, "'"); }
function levenshteinDistance(a,b){const m=Array(b.length+1).fill().map(()=>Array(a.length+1).fill(null));for(let i=0;i<=a.length;i++)m[0][i]=i;for(let j=0;j<=b.length;j++)m[j][0]=j;for(let j=1;j<=b.length;j++){for(let i=1;i<=a.length;i++){const indicator=a[i-1]===b[j-1]?0:1;m[j][i]=Math.min(m[j][i-1]+1,m[j-1][i]+1,m[j-1][i-1]+indicator);}}return m[b.length][a.length];}
function phoneticEncode(word){return word.toLowerCase().replace(/[aeiouy]/g,"").replace(/ph/g,"f").replace(/ck/g,"k").replace(/sh/g,"ch").replace(/[^a-z]/g,"");}
function phoneticRelax(word){
  let w=word.toLowerCase();
  w=w.replace(/r/g,"ʁ");
  w=w.replace(/[éèêë]/g,"e");
  w=w.replace(/[àâ]/g,"a");
  return w;
}

// Hover pronunciation
function playWord(word){
  if('speechSynthesis' in window){
    window.speechSynthesis.cancel();
    const utterance = new SpeechSynthesisUtterance(word);
    utterance.lang='fr-FR';
    utterance.rate=0.9;
    window.speechSynthesis.speak(utterance);
  }
}

// Initialize exercise
function initialize(){
  allSentences.sort(()=>Math.random()-0.5);
  exerciseSentences = allSentences.slice(0,Math.min(10,allSentences.length));
  currentIndex=0;
  updateUI();
}

function updateUI(){
  document.getElementById('counter').textContent=`Sentence ${currentIndex+1} / ${exerciseSentences.length}`;
  document.getElementById('sentenceDisplay').textContent=exerciseSentences[currentIndex].sentence;
  document.getElementById('feedback').textContent='';
  document.getElementById('transcriptOutput').textContent='';
  document.getElementById('recordButton').classList.remove('hide');
  document.getElementById('nextButton').classList.add('hide');
}

function toggleRecording(){
  if(!isRecording && recognition){
    try{
      recognition.start();
      isRecording=true;
      document.getElementById('recordButton').textContent='Recording...';
      document.getElementById('recordButton').classList.add('recording');
      document.getElementById('feedback').textContent='Listening...';
      document.getElementById('transcriptOutput').textContent='';
    } catch(e){
      console.error(e);
      isRecording=false;
    }
  }
}

function handleRecognitionResult(event){
  const transcript=event.results[0][0].transcript;
  checkPronunciation(transcript);
}

function handleRecognitionError(event){
  let errorMessage=`Error: ${event.error}`;
  if(event.error==='not-allowed'||event.error==='service-not-allowed') errorMessage="Microphone access denied.";
  else if(event.error==='no-speech') errorMessage="No speech detected. Try again.";
  document.getElementById('feedback').textContent=errorMessage;
  document.getElementById('feedback').style.color='red';
}

// Main pronunciation checking
function checkPronunciation(transcript){
  const feedbackEl=document.getElementById('feedback');
  const transcriptOutput=document.getElementById('transcriptOutput');
  const correctSentence=exerciseSentences[currentIndex].sentence;

  const punctuation=/[.,?!;:"-]/g;
  const finalTranscript=normalizeApostrophes(transcript).replace(punctuation,'').toLowerCase().trim();
  const finalCorrect=normalizeApostrophes(correctSentence).replace(punctuation,'').toLowerCase().trim();

  const transcriptWords=finalTranscript.split(/\s+/);
  const correctWords=finalCorrect.split(/\s+/);

  let matches=0;
  let wordsConsidered=0;
  let highlightedSentence=[];

  correctWords.forEach((word,i)=>{
    if(transcriptWords[i]){
      wordsConsidered++;
      const dist=levenshteinDistance(phoneticRelax(transcriptWords[i]),phoneticRelax(word));
      if(dist<=2||phoneticEncode(transcriptWords[i])===phoneticEncode(word)){
        matches++;
        highlightedSentence.push(`<span class="correct-word">${word}</span>`);
      } else {
        highlightedSentence.push(`<span class="wrong-word" 
          onmouseenter="playWord('${word.replace(/'/g,"\\'")}')"
          onmouseleave="window.speechSynthesis.cancel()"
          title="You said: '${transcriptWords[i]}'">${word}</span>`);
      }
    } else {
      highlightedSentence.push(`<span class="wrong-word" 
        onmouseenter="playWord('${word.replace(/'/g,"\\'")}')"
        onmouseleave="window.speechSynthesis.cancel()"
        title="(not detected)">${word}</span>`);
    }
  });

  // Sentence-level fallback
  const sentenceSim = (1 - levenshteinDistance(finalTranscript, finalCorrect)/Math.max(finalCorrect.length,1))*100;
  const similarity = wordsConsidered ? Math.max((matches/wordsConsidered)*100, sentenceSim) : sentenceSim;
  const threshold = correctWords.length>5?65:70;

  if(similarity>=threshold){
    feedbackEl.textContent=`Correct! (${similarity.toFixed(0)}% match)`;
    feedbackEl.style.color='green';
    transcriptOutput.innerHTML=highlightedSentence.join(" ");
    document.getElementById('recordButton').classList.add('hide');
    if(currentIndex<exerciseSentences.length-1) document.getElementById('nextButton').classList.remove('hide');
    else feedbackEl.textContent='🎉 Congratulations! You have completed the exercise.';
  } else {
    feedbackEl.textContent=`Not quite (${similarity.toFixed(0)}% match). Try again.`;
    feedbackEl.style.color='darkorange';
    transcriptOutput.innerHTML=`I heard: "${transcript}"<br>Expected: ${highlightedSentence.join(" ")}`;
  }
}

function nextSentence(){
  currentIndex++;
  updateUI();
}
</script>
</body>
</html>
