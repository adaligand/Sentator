<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dictation</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .container {
      width: 100%;
      max-width: 800px;
      padding: 30px;
      background-color: #fff;
      border-radius: 20px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      text-align: center;
      box-sizing: border-box;
    }
    .title {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    #counter {
      font-size: 22px;
      font-weight: bold;
      color: #666;
      margin-bottom: 25px;
    }
    button {
      font-size: 18px;
      padding: 12px 25px;
      cursor: pointer;
      border-radius: 10px;
      border: 2px solid #ccc;
      background-color: #f8f9fa;
      color: #333;
      transition: all 0.2s ease-in-out;
      font-weight: bold;
    }
    button:hover {
      background-color: #e2e6ea;
      border-color: #b3b9be;
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
    }
    #nextButton,
    #checkButton {
      background-color: #007bff;
      color: white;
      border-color: #007bff;
      white-space: nowrap;
    }
    #nextButton:hover,
    #checkButton:hover {
      background-color: #0056b3;
      border-color: #0056b3;
    }

    /* Input + button inline */
    .input-group {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 20px;
      gap: 10px;
    }
    #answerInput {
      font-size: 24px;
      padding: 12px 15px;
      flex: 1;
      border-radius: 12px;
      border: 2px solid #ddd;
      box-sizing: border-box;
    }
    #answerInput:focus {
      border-color: #007bff;
      outline: none;
    }

    #feedback {
      font-size: 20px;
      font-weight: bold;
      min-height: 24px;
      margin-top: 15px;
    }
    .keyboard-area {
      margin-top: 25px;
      padding-top: 20px;
      border-top: 1px solid #eee;
    }
    .keyboard-button {
      font-size: 18px;
      padding: 10px 15px;
      margin: 2px;
      border: none;
      border-radius: 10px;
      background-color: #eee;
      cursor: pointer;
    }
    .keyboard-button:hover {
      background-color: #A9A9A9;
      transform: translateY(-4px);
    }
    .top-controls {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    select {
      padding: 10px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">Dictation Activity</div>
    <div id="counter">Loading...</div>

    <div class="top-controls">
      <button id="playButton" onclick="playAudio()">‚ñ∂Ô∏è Play Audio</button>
      <select id="languageSelect" onchange="onLanguageChange()">
        <option value="french" selected>French</option>
        <option value="german">German</option>
        <option value="spanish">Spanish</option>
      </select>
    </div>

    <div class="input-group">
      <input
        type="text"
        id="answerInput"
        placeholder="Type what you hear..."
        autocomplete="off"
        spellcheck="false"
      />
      <button id="actionButton" onclick="checkAnswer()">Check</button>
    </div>

    <div id="feedback"></div>

    <div class="keyboard-area">
      <div id="keyboardContainer"></div>
    </div>
  </div>

  <script>
    let currentIndex = 0;
    let allSentences = [];
    let exerciseSentences = [];
    let voices = [];
    let voiceMap = {};
    let currentLanguage = "french";
    let isAnsweredCorrectly = false;

    const params = new URLSearchParams(window.location.search);
    const sheetUrl = params.get("sheet");

    if (!sheetUrl) {
      document.querySelector(".title").textContent = "‚ö†Ô∏è Error";
      document.getElementById("counter").textContent =
        "No Google Sheet URL was provided.";
    } else {
      Papa.parse(sheetUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: function (results) {
          results.data.forEach((row) => {
            if (row["French sentences"] && row["French sentences"].trim()) {
              allSentences.push(row["French sentences"].trim());
            }
          });
          if (allSentences.length === 0) {
            document.querySelector(".title").textContent = "‚ö†Ô∏è Error";
            document.getElementById("counter").textContent =
              "No sentences found.";
            return;
          }
          initialize();
        },
        error: function (err) {
          document.querySelector(".title").textContent = "‚ö†Ô∏è Error";
          document.getElementById("counter").textContent =
            "Error loading data.";
          console.error(err);
        },
      });
    }

    function loadVoices() {
      voices = window.speechSynthesis.getVoices();
      function findVoice(langCode, preferredNames = []) {
        return (
          voices.find((v) =>
            preferredNames.some((name) =>
              v.name.toLowerCase().includes(name.toLowerCase())
            )
          ) ||
          voices.find((v) => v.lang.toLowerCase().startsWith(langCode)) ||
          voices[0] ||
          null
        );
      }
      voiceMap = {
        french: findVoice("fr", ["google fran√ßais", "am√©lie", "thomas"]),
        german: findVoice("de", ["google deutsch", "markus", "petra"]),
        spanish: findVoice("es", ["google espa√±ol", "conchita", "lucia", "enrique"]),
      };
    }
    window.speechSynthesis.onvoiceschanged = loadVoices;
    if (speechSynthesis.getVoices().length) loadVoices();

    function initialize() {
      allSentences.sort(() => Math.random() - 0.5);
      exerciseSentences = allSentences.slice(0, Math.min(10, allSentences.length));
      currentIndex = 0;
      updateUI();
      generateKeyboard();
      playAudio();
    }

    function updateUI() {
      const total = exerciseSentences.length;
      document.getElementById(
        "counter"
      ).textContent = `Sentence ${currentIndex + 1} / ${total}`;
      const answerInput = document.getElementById("answerInput");
      answerInput.value = "";
      answerInput.disabled = false;
      answerInput.focus();
      document.getElementById("feedback").textContent = "";
      const btn = document.getElementById("actionButton");
      btn.textContent = "Check";
      btn.onclick = checkAnswer;
      isAnsweredCorrectly = false;
      playAudio();
    }

    function onLanguageChange() {
      currentLanguage = document.getElementById("languageSelect").value;
      generateKeyboard();
    }

    function playAudio() {
      if (!exerciseSentences[currentIndex]) return;
      const utterance = new SpeechSynthesisUtterance(
        exerciseSentences[currentIndex]
      );
      const voice = voiceMap[currentLanguage];
      if (voice) utterance.voice = voice;

      switch (currentLanguage) {
        case "french":
          utterance.lang = "fr-FR";
          break;
        case "german":
          utterance.lang = "de-DE";
          break;
        case "spanish":
          utterance.lang = "es-ES";
          break;
      }

      utterance.rate = 0.85;
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utterance);
    }

    function checkAnswer() {
      const answerInput = document.getElementById("answerInput");
      const feedbackEl = document.getElementById("feedback");
      const userAnswer = answerInput.value.trim();
      const correctAnswer = exerciseSentences[currentIndex];
      if (!userAnswer) {
        feedbackEl.textContent = "Please type your answer.";
        feedbackEl.style.color = "orange";
        return;
      }
      const punctuationRegex = /[.,?!;:"-]/g;
      const normalize = (t) =>
        t.replace(/‚Äô/g, "'").replace(punctuationRegex, "").toLowerCase().trim();
      if (normalize(userAnswer) === normalize(correctAnswer)) {
        feedbackEl.textContent = "‚úÖ Correct!";
        feedbackEl.style.color = "green";
        answerInput.disabled = true;
        isAnsweredCorrectly = true;
        const btn = document.getElementById("actionButton");
        btn.textContent =
          currentIndex < exerciseSentences.length - 1 ? "Next ‚ñ∂Ô∏è" : "üéâ Done!";
        btn.onclick =
          currentIndex < exerciseSentences.length - 1
            ? nextSentence
            : () => (feedbackEl.textContent = "üéâ Great job!");
      } else {
        feedbackEl.style.color = "darkorange";
        let correctPrefixLength = 0;
        const finalCorrect = normalize(correctAnswer);
        const finalUser = normalize(userAnswer);
        for (let i = 0; i < finalUser.length; i++) {
          if (i < finalCorrect.length && finalUser[i] === finalCorrect[i])
            correctPrefixLength++;
          else break;
        }
        const hint = correctAnswer.substring(0, correctPrefixLength + 1);
        feedbackEl.textContent = `Not quite. Hint: ${hint}...`;
      }
    }

    function nextSentence() {
      currentIndex++;
      updateUI();
    }

    document
      .getElementById("answerInput")
      .addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const btn = document.getElementById("actionButton");
          btn.click();
        }
      });

    function generateKeyboard() {
      const keyboardContainer = document.getElementById("keyboardContainer");
      keyboardContainer.innerHTML = "";
      let specialChars = [];
      switch (currentLanguage) {
        case "french":
          specialChars = [
            "√†",
            "√¢",
            "√©",
            "√®",
            "√™",
            "√´",
            "√Æ",
            "√Ø",
            "√¥",
            "√∂",
            "√π",
            "√º",
            "√ª",
            "√ß",
          ];
          break;
        case "german":
          specialChars = ["√§", "√∂", "√º", "√ü"];
          break;
        case "spanish":
          specialChars = ["√°", "√©", "√≠", "√≥", "√∫", "√±", "¬ø", "¬°"];
          break;
      }
      specialChars.forEach((char) => {
        const button = document.createElement("button");
        button.textContent = char;
        button.className = "keyboard-button";
        button.onclick = () => insertLetter(char);
        keyboardContainer.appendChild(button);
      });
    }

    function insertLetter(letter) {
      const input = document.getElementById("answerInput");
      const start = input.selectionStart;
      const end = input.selectionEnd;
      input.value =
        input.value.substring(0, start) +
        letter +
        input.value.substring(end);
      input.selectionStart = input.selectionEnd = start + 1;
      input.focus();
    }
  </script>
</body>
</html>
