<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vocabulary Spinner</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f9;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      padding: 20px;
      box-sizing: border-box;
    }
    .game-wrapper {
      background-color: white;
      padding: 20px 40px;
      border-radius: 15px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: center;
    }
    .game-content {
      display: flex;
      align-items: center;
      gap: 40px;
    }
    .right-panel {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 320px;
    }
    #spinner-container {
      position: relative;
      width: 400px;
      height: 400px;
    }
    #spinner-canvas {
      width: 100%;
      height: 100%;
      transition: transform 5s cubic-bezier(0.25, 1, 0.5, 1);
      cursor: pointer;
    }
    #spinner-pointer {
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 20px solid transparent;
      border-right: 20px solid transparent;
      border-top: 30px solid #dc3545;
      z-index: 10;
    }
    .hide { display: none !important; }
    #qa-container:not(.hide),
    #prompt-container:not(.hide),
    #mode-select:not(.hide) {
      padding: 15px;
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      opacity: 0;
      animation: fadeIn 0.5s forwards;
    }
    @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }
    #prompt-container { font-size: 22px; font-weight: bold; color: #6c757d; }
    #qa-container #feedback { display: none; }
    #qa-container.feedback-mode #selected-term,
    #qa-container.feedback-mode #answerInput,
    #qa-container.feedback-mode #submitAnswer { display: none; }
    #qa-container.feedback-mode #feedback { display: block; }
    #selected-term { font-size: 22px; font-weight: bold; margin-bottom: 10px;}
    #answerInput { padding: 8px; font-size: 16px; border-radius: 5px; border: 1px solid #ccc; width: 80%; margin: 0 auto; }
    #feedback { font-weight: bold; min-height: 24px; margin-top: 10px; }
    #choice-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 10px;}
    #remove-word-btn, #keep-word-btn, #submitAnswer {
      border: 1px solid #ccc; font-size: 14px; cursor: pointer; padding: 5px 10px; border-radius: 5px;
      min-width: 80px;
    }
    #remove-word-btn { background-color: #fdd; }
    #keep-word-btn { background-color: #dfd; }
    #submitAnswer { margin-top: 10px; background-color: #007bff; color: white; border-color: #007bff; }
    .keyboard-controls { padding: 15px; background-color: #e9ecef; border-radius: 10px; }
    .keyboard-controls.hide { display: none !important; }
    #languageSelect { padding: 5px 10px; border-radius: 10px; font-size: 16px; margin-bottom: 10px; }
    #keyboardContainer {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 8px; margin: 0 auto;
    }
    .keyboard-button {
      background-color: white; border: 1px solid #ccc; border-radius: 5px;
      font-size: 20px; width: 40px; height: 40px; cursor: pointer;
    }
    .score-display { font-size: 20px; font-weight: bold; margin: 5px 0; color: #333; }
  </style>
</head>
<body>

<div class="game-wrapper">
  <h1>Vocabulary Spinner</h1>
  
  <div id="mode-select">
    <p>Select Game Mode:</p>
    <button id="one-player-btn">1 Player</button>
    <button id="two-player-btn">2 Players</button>
  </div>
  
  <div id="scoreboard" class="hide">
    <div class="score-display" id="p1-score">Player 1 Score: <span>0</span></div>
    <div class="score-display hide" id="p2-score">Player 2 Score: <span>0</span></div>
    <div id="turn-indicator" class="hide">Current Turn: Player 1</div>
  </div>
  
  <div class="game-content">
    <div id="spinner-container">
      <div id="spinner-pointer"></div>
      <canvas id="spinner-canvas" width="400" height="400"></canvas>
    </div>
    <div class="right-panel">
      <div id="prompt-container" class="hide">Click the wheel to spin!</div>
      <div id="qa-container" class="hide">
        <div id="selected-term"></div>
        <input type="text" id="answerInput" placeholder="Type term...">
        <button id="submitAnswer">Submit</button>
        <div id="feedback"><span id="feedback-text"></span></div>
      </div>
      <div class="keyboard-controls hide">
        <select id="languageSelect">
          <option value="french" selected>French</option>
          <option value="german">German</option>
          <option value="spanish">Spanish</option>
        </select>
        <div id="keyboardContainer"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  let vocabList = [];
  const colors = ["#1abc9c","#16a085","#2ecc71","#27ae60","#3498db","#2980b9","#9b59b6","#8e44ad","#e74c3c","#c0392b","#d35400","#e67e22","#f1c40f"];
  let currentRotation = 0;
  let lastSelectedItem = null;
  let isSpinning = false;
  let gameOver = false;
  let gameMode = null;
  let currentPlayer = 1;
  let scores = {1:0,2:0};

  const canvas = document.getElementById('spinner-canvas');
  const ctx = canvas.getContext('2d');
  const qaContainer = document.getElementById('qa-container');
  const promptContainer = document.getElementById('prompt-container');
  const selectedTermEl = document.getElementById('selected-term');
  const answerInputEl = document.getElementById('answerInput');
  const submitAnswerBtn = document.getElementById('submitAnswer');
  const feedbackTextEl = document.getElementById('feedback-text');
  const languageSelect = document.getElementById('languageSelect');
  const keyboardControls = document.querySelector('.keyboard-controls');
  const modeSelect = document.getElementById('mode-select');
  const scoreboard = document.getElementById('scoreboard');
  const p1ScoreEl = document.querySelector('#p1-score span');
  const p2ScoreEl = document.querySelector('#p2-score span');
  const p2ScoreContainer = document.getElementById('p2-score');
  const turnIndicator = document.getElementById('turn-indicator');

  const params = new URLSearchParams(window.location.search);
  const sheetUrl = params.get('sheet');
  if (!sheetUrl) { document.querySelector('.game-wrapper').innerHTML = "<h1>⚠️ No sheet URL provided.</h1>"; return; }

  Papa.parse(sheetUrl, {
    download: true, header: false, skipEmptyLines: true,
    complete: (results) => {
      results.data.forEach((row, index) => {
        if (index > 0 && row[1] && row[2]) vocabList.push({term:row[1].trim(), translation:row[2].trim()});
      });
      if (vocabList.length < 2) { document.querySelector('.game-wrapper').innerHTML = "<h1>⚠️ Not enough vocabulary.</h1>"; return; }
      drawSpinner();
      generateKeyboard('french');
    }
  });

  function setUIState(state) {
    if (state==='prompt'){ promptContainer.classList.remove('hide'); qaContainer.classList.add('hide'); keyboardControls.classList.add('hide');}
    else if (state==='question'){ promptContainer.classList.add('hide'); qaContainer.classList.remove('hide'); keyboardControls.classList.remove('hide');}
    else if (state==='spinning'){ promptContainer.classList.add('hide'); qaContainer.classList.add('hide'); keyboardControls.classList.add('hide');}
  }

  function drawSpinner() {
    if (vocabList.length===0) {
      ctx.clearRect(0,0,400,400); ctx.textAlign="center"; ctx.font="20px Arial"; ctx.fillText("All words answered!",200,200);
      gameOver=true; canvas.style.cursor='default'; setUIState('spinning'); return;
    }
    const arc=(2*Math.PI)/vocabList.length; ctx.clearRect(0,0,400,400); ctx.strokeStyle="#333"; ctx.lineWidth=2; ctx.font='14px Arial';
    for(let i=0;i<vocabList.length;i++){ const angle=i*arc; ctx.fillStyle=colors[i%colors.length];
      ctx.beginPath(); ctx.arc(200,200,198,angle,angle+arc,false); ctx.arc(200,200,0,angle+arc,angle,true); ctx.fill(); ctx.stroke();
      ctx.save(); ctx.fillStyle="#fff"; ctx.translate(200,200); ctx.rotate(angle+arc/2); ctx.textAlign="right";
      ctx.fillText(vocabList[i].translation,180,5); ctx.restore();}
  }

  function spin(){
    if(isSpinning||gameOver) return;
    isSpinning=true; setUIState('spinning');
    const selectedIndex=Math.floor(Math.random()*vocabList.length); lastSelectedItem=vocabList[selectedIndex];
    const arcSize=360/vocabList.length; const targetMiddleAngle=(selectedIndex*arcSize)+(arcSize/2);
    let finalOrientation=270-targetMiddleAngle; let finalRotation=finalOrientation;
    while(finalRotation<=currentRotation){finalRotation+=360;} finalRotation+=(Math.floor(Math.random()*4)+4)*360;
    canvas.style.transform=`rotate(${finalRotation}deg)`; currentRotation=finalRotation; setTimeout(onSpinEnd,5000);
  }

  function onSpinEnd(){
    setUIState('question'); qaContainer.classList.remove('feedback-mode');
    selectedTermEl.textContent=`Term for: "${lastSelectedItem.translation}"`; answerInputEl.dataset.correctAnswer=lastSelectedItem.term;
    answerInputEl.value=''; answerInputEl.focus();
  }

  function updateScoreDisplay(){ p1ScoreEl.textContent=scores[1]; p2ScoreEl.textContent=scores[2]; }
  function switchTurn(){ currentPlayer=(currentPlayer===1?2:1); turnIndicator.textContent=`Current Turn: Player ${currentPlayer}`; }

  function handleAnswer(){
    const userAnswer=answerInputEl.value.trim().toLowerCase();
    const correctAnswer=answerInputEl.dataset.correctAnswer.toLowerCase();
    qaContainer.classList.add('feedback-mode');
    if(userAnswer===correctAnswer){
      scores[currentPlayer]++; updateScoreDisplay();
      feedbackTextEl.textContent="✅ Correct!";
      feedbackTextEl.style.color="green";
      if(gameMode==="2p"){ setTimeout(()=>{switchTurn(); continueGame();},1500); }
      else { // 1p mode: show keep/remove buttons
        document.getElementById('choice-buttons').classList.remove('hide');
      }
    } else {
      if(gameMode==="1p"){
        let correctPrefixLength=0;
        for(let i=0;i<userAnswer.length;i++){ if(i<correctAnswer.length&&userAnswer[i]===correctAnswer[i]) correctPrefixLength++; else break; }
        const hint=correctAnswer.substring(0,correctPrefixLength+1);
        feedbackTextEl.textContent=`Hint: ${hint}...`; feedbackTextEl.style.color="orange"; isSpinning=false;
      } else {
        feedbackTextEl.textContent="❌ Wrong! Turn passes."; feedbackTextEl.style.color="red";
        setTimeout(()=>{switchTurn(); continueGame();},1500);
      }
    }
    answerInputEl.value='';
  }

  function continueGame(){ setUIState('prompt'); isSpinning=false; }

  // keep/remove only visible in 1P mode
  document.getElementById('remove-word-btn').addEventListener('click',()=>{ if(!lastSelectedItem)return;
    const idx=vocabList.findIndex(item=>item.term===lastSelectedItem.term&&item.translation===lastSelectedItem.translation);
    if(idx>-1) vocabList.splice(idx,1); drawSpinner(); lastSelectedItem=null; continueGame(); });
  document.getElementById('keep-word-btn').addEventListener('click',continueGame);

  function generateKeyboard(lang){ const kb=document.getElementById('keyboardContainer'); kb.innerHTML=''; let chars=[];
    if(lang==='french') chars=['à','â','é','è','ê','î','ô','û','ç'];
    else if(lang==='german') chars=['ä','ö','ü','ß'];
    else if(lang==='spanish') chars=['á','é','í','ó','ú','ñ'];
    chars.forEach(c=>{const b=document.createElement('button'); b.textContent=c; b.className='keyboard-button';
      b.onclick=()=>insertLetter(c); kb.appendChild(b);});
  }
  function insertLetter(letter){ const start=answerInputEl.selectionStart; const end=answerInputEl.selectionEnd;
    answerInputEl.value=answerInputEl.value.substring(0,start)+letter+answerInputEl.value.substring(end);
    answerInputEl.selectionStart=answerInputEl.selectionEnd=start+1; answerInputEl.focus(); }

  canvas.addEventListener('click',spin);
  submitAnswerBtn.addEventListener('click',handleAnswer);
  answerInputEl.addEventListener('keypress',(e)=>{if(e.key==='Enter') handleAnswer();});
  languageSelect.addEventListener('change',(e)=>generateKeyboard(e.target.value));

  document.getElementById('one-player-btn').addEventListener('click',()=>{
    gameMode="1p"; modeSelect.classList.add('hide'); scoreboard.classList.remove('hide'); setUIState('prompt');
  });
  document.getElementById('two-player-btn').addEventListener('click',()=>{
    gameMode="2p"; modeSelect.classList.add('hide'); scoreboard.classList.remove('hide');
    p2ScoreContainer.classList.remove('hide'); turnIndicator.classList.remove('hide'); setUIState('prompt');
  });
});
</script>
</body>
</html>
