<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EAL Flashcards Game</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            min-height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
        }
        .game-wrapper {
            background-color: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .flashcard-container {
            perspective: 1000px;
            margin-bottom: 20px;
        }
        .flashcard {
            width: 500px;
            height: 300px;
            background: white;
            border-radius: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 50px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
            transform-style: preserve-3d;
            transition: transform 0.6s;
            position: relative;
        }
        .flipped {
            transform: rotateY(180deg);
        }
        .flashcard .front, .flashcard .back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            box-sizing: border-box;
            padding: 10px;
        }
        .flashcard .front {
            border: 1px solid #ddd;
            background-color: white;
        }
        .flashcard .back {
            background-color: white;
            border: 15px solid #6c99bb;
            transform: rotateY(180deg);
        }
        .button-container {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        button {
            font-size: 20px;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
            border-radius: 10px;
            border: 2px solid #ccc;
            background-color: #f0f0f0;
            transition: all 0.2s ease-in-out;
        }
        button:hover {
            background-color: #A9A9A9;
            transform: translateY(-4px);
        }
        .quiz-container,
        .text-input-container,
        .reset-container {
            display: none;
            margin-top: 20px;
            text-align: center;
        }
        .quiz-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 20px;
        }
        .quiz-options button {
            width: 200px;
            height: 100px;
            font-size: 20px;
        }
        input {
            font-size: 20px;
            padding: 10px;
            border-radius: 10px;
        }
        .congratulations {
            font-size: 24px;
            font-weight: bold;
            color: green;
            margin-top: 20px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="game-wrapper">
        <div class="flashcard-container">
            <div class="flashcard" onclick="flipCard()">
                <div class="front" id="frontText">Loading...</div>
                <div class="back" id="backText">Loading...</div>
            </div>
        </div>
        <div class="button-container">
            <button onclick="previousStep()" id="previousButton" class="hidden">Previous</button>
            <button onclick="nextStep()">Next</button>
        </div>
        <div class="quiz-container" id="quizContainer"></div>
        <div class="text-input-container" id="textInputContainer"></div>
        <div class="reset-container">
            <button onclick="resetExercise()">Restart Exercise</button>
        </div>
        <div class="congratulations hidden" id="congratulationsMessage"></div>
    </div>

<script>
    let currentIndex = 0,
        phase = 0,
        cycleIndex = 0;
    let englishWords = [],
        translations = []; // This will hold the image URLs
    const params = new URLSearchParams(window.location.search);
    const sheetUrl = params.get('sheet');
    const gameType = params.get('game') || 'eal'; // Default to 'eal'
    
    if (!sheetUrl) {
        alert('Error: No sheet URL provided in the address bar.');
    }
    
    Papa.parse(sheetUrl, {
        download: true,
        header: false,
        skipEmptyLines: true,
        complete: function(results) {
            results.data.forEach((row, index) => {
                if (index === 0) {
                    return; // Skip header row
                }
                if (gameType === 'eal' && row[1] && row[2]) {
                    englishWords.push(row[1].trim()); // Column B: English word
                    translations.push(row[2].trim()); // Column C: Image URL
                }
            });
            
            if (englishWords.length === 0) {
                alert("No valid data found. Please check your spreadsheet has an English word in Column B and an Image URL in Column C.");
                return;
            }
            nextStep();
        },
        error: function(err) {
            console.error(err);
            alert("Error loading or parsing the CSV file. Please check that the URL is correct and the sheet is published as a CSV.");
        }
    });

    function flipCard() {
        document.querySelector('.flashcard').classList.toggle('flipped');
    }

    // âœ… CHANGE: This function now shows the English word on the FRONT and the image on the BACK.
    function updateCard(index) {
        if (index >= englishWords.length) return;
        
        const front = document.getElementById('frontText');
        const back = document.getElementById('backText');

        // Clear previous content from both sides
        front.innerHTML = '';
        back.innerHTML = '';

        // Set the English word as the text for the FRONT of the card
        front.textContent = englishWords[index];

        // Create and display an image on the BACK of the card
        const img = document.createElement('img');
        img.src = translations[index]; // The URL from the spreadsheet
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.style.borderRadius = '10px';
        back.appendChild(img);
        
        // Reset the flip animation
        document.querySelector('.flashcard').classList.remove('flipped');
    }

    function showQuiz(index) {
        const quizContainer = document.getElementById('quizContainer');
        quizContainer.innerHTML = '';

        const correctAnswer = englishWords[index];
        const quizOptions = shuffle([correctAnswer, ...englishWords.filter((w, i) => i !== index).slice(0, 3)]);
        
        // The prompt for the quiz is now the English word, asking for the right image (implicitly)
        // Since we can't show 4 images easily, the quiz will show an image and ask for the word.
        const optionsPrompt = `
            <h3>Choose the word for this image:</h3>
            <img src="${translations[index]}" style="height: 150px; margin-bottom: 15px; border-radius: 10px;">
        `;

        let div = document.createElement('div');
        div.innerHTML = optionsPrompt;
        let optionsDiv = document.createElement('div');
        optionsDiv.className = "quiz-options";
        
        quizOptions.forEach(option => {
            let btn = document.createElement('button');
            btn.textContent = option;
            btn.onclick = () => {
                if (option === correctAnswer) {
                    nextStep();
                } else {
                    alert("Incorrect! Let's try that pair again.");
                    phase = (phase <= 1) ? 0 : (phase <= 3) ? 2 : 4;
                    nextStep();
                }
            };
            optionsDiv.appendChild(btn);
        });
        div.appendChild(optionsDiv);
        quizContainer.appendChild(div);
    }

    function showTextInput(index) {
        const textInputContainer = document.getElementById('textInputContainer');
        // The prompt shows the image and asks the user to type the English word.
        const promptHTML = `
            <h3>Type the word for this image:</h3>
            <img src="${translations[index]}" style="height: 150px; margin-bottom: 15px; border-radius: 10px;">
        `;

        textInputContainer.innerHTML = `
            ${promptHTML}
            <input type="text" id="userInput" placeholder="Type here..." autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
            <button id="submitBtn">Submit</button>
            <div id="feedback" style="margin-top: 10px; font-size: 18px; min-height: 24px; font-weight: bold;"></div>
        `;

        const input = document.getElementById('userInput');
        const submitBtn = document.getElementById('submitBtn');
        const feedbackEl = document.getElementById('feedback');
        input.focus();

        const checkAnswer = () => {
            const userInput = input.value.trim();
            const correctAnswer = englishWords[index];
            
            if (userInput.toLowerCase() === correctAnswer.toLowerCase()) {
                feedbackEl.textContent = 'Correct!';
                feedbackEl.style.color = 'green';
                input.disabled = true;
                submitBtn.disabled = true;
                setTimeout(nextStep, 1000);
            } else {
                feedbackEl.style.color = 'darkorange';
                const hint = correctAnswer.substring(0, 1);
                feedbackEl.textContent = `Hint: Starts with "${hint}"...`;
            }
        };

        submitBtn.onclick = checkAnswer;
        input.addEventListener('keydown', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                checkAnswer();
            }
        });
    }

    function nextStep() {
        const flashcardContainer = document.querySelector('.flashcard-container');
        const quizContainer = document.getElementById('quizContainer');
        const textInputContainer = document.getElementById('textInputContainer');
        const buttonContainer = document.querySelector('.button-container');
        const previousButton = document.getElementById('previousButton');

        if (cycleIndex === 0 && phase === 0) {
            previousButton.classList.add('hidden');
        } else {
            previousButton.classList.remove('hidden');
        }

        flashcardContainer.style.display = 'none';
        quizContainer.style.display = 'none';
        textInputContainer.style.display = 'none';
        buttonContainer.style.display = 'none';
        
        if (cycleIndex * 2 >= englishWords.length && phase > 1) {
            showCongratulations();
            return;
        }

        let firstIndex = cycleIndex * 2;
        let secondIndex = firstIndex + 1;

        switch (phase) {
            case 0:
                flashcardContainer.style.display = 'block';
                buttonContainer.style.display = 'flex';
                updateCard(firstIndex);
                break;
            case 1:
                flashcardContainer.style.display = 'block';
                buttonContainer.style.display = 'flex';
                if (secondIndex < englishWords.length) {
                    updateCard(secondIndex);
                } else {
                    phase = 5; // Skip to the end if there's no second card
                    nextStep();
                    return;
                }
                break;
            case 2:
                quizContainer.style.display = 'block';
                showQuiz(firstIndex);
                break;
            case 3:
                quizContainer.style.display = 'block';
                if (secondIndex < englishWords.length) {
                    showQuiz(secondIndex);
                } else {
                    phase = 5; // Skip
                    nextStep();
                    return;
                }
                break;
            case 4:
                textInputContainer.style.display = 'block';
                showTextInput(firstIndex);
                break;
            case 5:
                textInputContainer.style.display = 'block';
                if (secondIndex < englishWords.length) {
                    showTextInput(secondIndex);
                } else {
                    showCongratulations();
                    return;
                }
                break;
            default:
                cycleIndex++;
                phase = 0;
                nextStep();
                return;
        }
        phase++;
    }

    function previousStep() {
        phase -= 2;
        if (phase < 0) {
            if (cycleIndex > 0) {
                cycleIndex--;
                phase = 5; 
                if (cycleIndex * 2 + 1 >= englishWords.length) {
                    phase = 4;
                }
            } else {
                phase = 0;
            }
        }
        nextStep();
    }

    function shuffle(array) {
        return array.sort(() => Math.random() - 0.5);
    }

    function showCongratulations() {
        document.querySelector('.flashcard-container').style.display = 'none';
        document.querySelector('.quiz-container').style.display = 'none';
        document.querySelector('.text-input-container').style.display = 'none';
        document.querySelector('.button-container').style.display = 'none';
        let msg = document.getElementById('congratulationsMessage');
        msg.classList.remove('hidden');
        msg.textContent = "Congratulations! You've completed all the exercises!";
        document.querySelector('.reset-container').style.display = 'block';
    }

    function resetExercise() {
        cycleIndex = 0;
        phase = 0;
        document.getElementById('congratulationsMessage').classList.add('hidden');
        document.querySelector('.reset-container').style.display = 'none';
        nextStep();
    }
</script>
</body>
</html>
