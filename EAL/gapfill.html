<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gapfill</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f9;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        box-sizing: border-box;
    }
    .game-wrapper {
        background-color: white;
        padding: 20px 40px;
        border-radius: 15px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 900px;
    }
    .container {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
      font-size: 16px;
    }
    .title {
      font-size: 40px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }
    .subtitle {
      font-size: 20px;
      margin-bottom: 10px;
      text-align: center;
    }
    .counter {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }
    button {
      padding: 10px 20px;
      background-color: #f9f9f9;
      border: 2px solid #ccc;
      color: #000000;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease-in-out;
    }
    button:hover {
      background-color: #A9A9A9;
      transform: translateY(-4px);
    }
    .hide {
      display: none;
    }
    .english-sentence {
      margin-bottom: 20px;
      font-size: 24px;
      line-height: 1.5;
      padding: 20px;
      border: 2px solid #ccc;
      border-radius: 10px;
      background-color: #f9f9f9;
      text-align: center;
    }
    .missing-word {
      border: none;
      border-bottom: 2px solid #333;
      border-radius: 0;
      padding: 5px;
      font-size: 22px;
      min-width: 40px;
      text-align: center;
      background: transparent;
    }
    .feedback-container {
      display: flex;
      align-items: center;
      gap: 15px;
      justify-content: center;
      margin-top: 15px;
    }
    .feedback {
      font-weight: bold;
      font-size: 18px;
    }
  </style>
</head>
<body>
<div class="game-wrapper">
    <div class="container">
      <div class="title">Gapfill</div>
      <div class="subtitle" id="subtitle">Fill in the gaps:</div>
      <div class="counter" id="sentenceCounter"></div>

      <div id="exerciseOutput"></div>

      <div class="feedback-container">
        <div id="feedback" class="hide"></div>
        <button id="nextButton" class="hide" onclick="nextText()">Next</button>
      </div>

      <button id="resetButton" class="hide" onclick="resetActivity()">Restart</button>
    </div>
</div>

  <script>
    let currentTextIndex = 0;
    let allSentences = [];
    let exerciseSentences = [];
    let originalChunks = [];

    const params = new URLSearchParams(window.location.search);
    const sheetUrl = params.get('sheet');

    if (!sheetUrl) {
        document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No sheet URL provided.</h1>";
    } else {
        Papa.parse(sheetUrl, {
            download: true,
            header: false,
            skipEmptyLines: true,
            complete: function(results) {
                results.data.forEach((row, index) => {
                    if (index === 0) return;
                    if (row[5] && row[5].trim()) {
                        allSentences.push({ english: row[5].trim() });
                    }
                });

                if (allSentences.length === 0) {
                    document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è No data found in Column F.</h1>";
                    return;
                }
                
                initializeChunk();
            },
            error: function(err) {
                console.error(err);
                document.querySelector('.container').innerHTML = "<h1>‚ö†Ô∏è Error loading CSV file.</h1>";
            }
        });
    }

    function initializeChunk() {
      exerciseSentences = shuffleArray([...allSentences]).slice(0, 10);
      currentTextIndex = 0;
      generateChunk();
    }

    function shuffleArray(array) {
      for (var i = array.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    function generateChunk() {
      if (currentTextIndex >= exerciseSentences.length) {
          document.getElementById('exerciseOutput').innerHTML = '<h2>üéâ Well done!</h2>';
          document.getElementById('nextButton').classList.add('hide');
          document.getElementById('resetButton').classList.remove('hide');
          return;
      }

      var englishSentence = exerciseSentences[currentTextIndex].english;
      originalChunks = getWordChunks(englishSentence);

      const wordIndices = [];
      originalChunks.forEach((chunk, index) => {
          if (chunk.match(/\w/)) { // A chunk is a "word" if it contains a word character
              wordIndices.push(index);
          }
      });

      const numWordsToRemove = Math.max(1, Math.floor(wordIndices.length * 0.3));
      const removedChunksIndices = shuffleArray([...wordIndices]).slice(0, numWordsToRemove);

      var sentenceWithInputFields = '';
      for (var i = 0; i < originalChunks.length; i++) {
          if (removedChunksIndices.includes(i)) {
              sentenceWithInputFields += `<input type="text" class="missing-word" data-index="${i}" onchange="checkAnswers()" oninput="expandInput(this)" style="width: 40px;">`;
          } else {
              sentenceWithInputFields += originalChunks[i];
          }
      }

      var exerciseOutput = document.getElementById('exerciseOutput');
      exerciseOutput.innerHTML = '';
      var sentenceDiv = document.createElement('div');
      sentenceDiv.classList.add('english-sentence');
      sentenceDiv.innerHTML = sentenceWithInputFields;
      exerciseOutput.appendChild(sentenceDiv);
      exerciseOutput.classList.remove('hide');

      document.getElementById('feedback').classList.add('hide');
      document.getElementById('nextButton').classList.add('hide');
      document.getElementById('resetButton').classList.add('hide');

      document.getElementById('sentenceCounter').textContent = (currentTextIndex + 1) + '/' + exerciseSentences.length;
    }

    function expandInput(input) {
      var minWidth = 40;
      var expansionFactor = 12;
      var newWidth = Math.max(minWidth, (input.value.length) * expansionFactor + 10);
      input.style.width = newWidth + 'px';
    }

    function nextText() {
        currentTextIndex++;
        generateChunk();
    }

    function resetActivity() {
      initializeChunk();
    }

    // ‚úÖ FIX: This new function correctly separates words, spaces, and punctuation.
    function getWordChunks(text) {
        return text.match(/\w+|[^\w\s]|\s+/g) || [];
    }

    function checkAnswers() {
      var inputFields = document.querySelectorAll('.missing-word');
      var allFilled = true;
      var correctAnswers = 0;
      for (var i = 0; i < inputFields.length; i++) {
        var inputIndex = inputFields[i].getAttribute('data-index');
        var userInput = inputFields[i].value.trim();
        var correctWord = originalChunks[inputIndex];
        
        expandInput(inputFields[i]);

        if (userInput.toLowerCase() === correctWord.toLowerCase()) {
          correctAnswers++;
          inputFields[i].style.borderColor = 'green';
        } else {
          inputFields[i].style.borderColor = 'red';
        }
        if (userInput === '') {
          allFilled = false;
        }
      }

      if (allFilled) {
        var feedbackElement = document.getElementById('feedback');
        if (correctAnswers === inputFields.length) {
          feedbackElement.textContent = 'All answers are correct!';
          feedbackElement.classList.remove('hide');
          document.getElementById('nextButton').classList.remove('hide');
          if (currentTextIndex === exerciseSentences.length - 1) {
             document.getElementById('resetButton').classList.remove('hide');
             document.getElementById('nextButton').classList.add('hide');
          }
        } else {
          feedbackElement.textContent = `There are ${inputFields.length - correctAnswers} incorrect answers.`;
          feedbackElement.classList.remove('hide');
        }
      }
    }
  </script>
</body>

</html>
