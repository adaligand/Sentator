<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>No consonants</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; }
.container { width: 100%; padding: 20px; box-sizing: border-box; font-size: 16px; }
.title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
.subtitle { font-size: 20px; margin-bottom: 10px; text-align: center; }
.english-sentence { font-size: 24px; text-align: center; margin-bottom: 20px; padding: 10px 20px; border-radius: 10px; background-color: #eee; }
.french-sentence { font-size: 30px; text-align: center; margin-bottom: 20px; word-spacing: 20px; }
.missing-word { width: 20px; font-size: 30px; border: none; border-bottom: 1px solid #000; background: transparent; text-align: center; margin-right: 2px; }
.correct { background-color: #cef4ce; }
.incorrect { background-color: #ffb6c19c; }
.keyboard-container { text-align: center; margin-top: 20px; }
.keyboard-button { font-size: 18px; padding: 10px 15px; margin: 2px; border: none; border-radius: 10px; background-color: #eee; cursor: pointer; }
.keyboard-button:hover { background-color: #A9A9A9; transform: translateY(-4px); }
.feedback { font-weight: bold; font-size: 18px; display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
 <div class="title">No consonants</div>
 <div class="subtitle">Fill in the missing consonants</div>
 <div class="english-sentence" id="englishSentence"></div>
 <div class="french-sentence" id="frenchSentence"></div>
 <div id="keyboardContainer" class="keyboard-container"></div>
 <div id="feedback" class="feedback" style="display:none;">
   <span>Correct ✅</span>
   </div>
</div>

<script>
let lastFocusedInput = null;
let currentFrenchSentence = ''; // A single variable to hold the French text

const consonants = /[bcdfghjklmnpqrstvwxyzßçñBCDFGHJKLMNPQRSTVWXYZ]/;

// Get CSV URL from query string
const params = new URLSearchParams(window.location.search);
const csvUrl = params.get('sheet');

if(!csvUrl){
  document.getElementById('englishSentence').textContent = "⚠️ No CSV URL provided in query string.";
}

// Load CSV
Papa.parse(csvUrl, {
  download: true,
  header: false, // Treat the sheet as a simple grid, not a table with headers
  skipEmptyLines: false, // We need to preserve row numbers
  complete: function(results){
    try {
      // Directly access the data using array coordinates (zero-indexed)
      // Cell G2 is at row 1, column 6
      const frenchText = results.data[1][6]; 
      // Cell G5 is at row 4, column 6
      const englishText = results.data[4][6];

      if (frenchText && englishText) {
        currentFrenchSentence = frenchText.trim(); // Store the sentence for validation later
        generateSentence(currentFrenchSentence, englishText.trim());
        generateKeyboard();
      } else {
        throw new Error("Text not found in the correct cells.");
      }
    } catch (e) {
      console.error(e);
      document.getElementById('englishSentence').textContent = "⚠️ Error: Could not find text in cells G2 and G5. Please check your sheet's structure.";
    }
  },
  error: function(err){
    console.error(err);
    document.getElementById('englishSentence').textContent = "⚠️ CSV load error: " + err;
  }
});

// Generate the sentence on the page
function generateSentence(frenchSentence, englishSentence){
  document.getElementById('englishSentence').textContent = englishSentence;
  const sentenceDiv = document.getElementById('frenchSentence');
  sentenceDiv.innerHTML = '';

  for(let i=0; i<frenchSentence.length; i++){
    const char = frenchSentence[i];
    if(consonants.test(char)){
      const input = document.createElement('input');
      input.type = 'text';
      input.maxLength = 1;
      input.className = 'missing-word';
      input.dataset.index = i;
      input.addEventListener('input', validateInput);
      input.addEventListener('focus', () => { lastFocusedInput = input; });
      input.addEventListener('keydown', handleBackspace);
      sentenceDiv.appendChild(input);
    } else {
      const span = document.createElement('span');
      span.textContent = char;
      sentenceDiv.appendChild(span);
    }
  }
  document.getElementById('feedback').style.display = "none";
}

// Validate input
function validateInput(e){
  const input = e.target;
  // Use the stored single sentence for checking the correct character
  const correctChar = currentFrenchSentence[input.dataset.index];

  if(input.value.toLowerCase() === correctChar.toLowerCase()){
    input.classList.add('correct');
    input.classList.remove('incorrect');
  } else {
    input.classList.add('incorrect');
    input.classList.remove('correct');
  }

  // Move to next input automatically
  if(input.value.length === 1){
    let nextInput = input.nextElementSibling;
    while(nextInput && !nextInput.classList.contains('missing-word')){
      nextInput = nextInput.nextElementSibling;
    }
    if(nextInput) nextInput.focus();
  }

  // Show feedback if all correct
  const allInputs = document.querySelectorAll('.missing-word');
  const allCorrect = Array.from(allInputs).every(inp => inp.classList.contains('correct'));
  if(allCorrect){
    document.getElementById('feedback').style.display = "flex";
  }
}

// Handle backspace
function handleBackspace(e){
  if(e.key === "Backspace"){
    const input = e.target;
    if(input.value === ''){
      e.preventDefault();
      let prevInput = input.previousElementSibling;
      while(prevInput && !prevInput.classList.contains('missing-word')){
        prevInput = prevInput.previousElementSibling;
      }
      if(prevInput){
        prevInput.focus();
        prevInput.value = '';
        prevInput.classList.remove('correct','incorrect');
      }
    }
  }
}

// Keyboard
function generateKeyboard(){
  const container = document.getElementById('keyboardContainer');
  container.innerHTML = '';
  const chars = ['ß', 'ç', 'ñ'];
  chars.forEach(c => {
    const btn = document.createElement('button');
    btn.textContent = c;
    btn.className = 'keyboard-button';
    btn.type = 'button';
    btn.onclick = () => {
      if(lastFocusedInput){
        const pos = lastFocusedInput.selectionStart;
        const val = lastFocusedInput.value;
        lastFocusedInput.value = val.slice(0,pos) + c + val.slice(pos);
        lastFocusedInput.setSelectionRange(pos+1,pos+1);
        lastFocusedInput.focus();
        lastFocusedInput.dispatchEvent(new Event('input'));
      }
    };
    container.appendChild(btn);
  });
}
</script>
</body>
</html>
