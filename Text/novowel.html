<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>No vowels</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; }
.container { width: 100%; padding: 20px; box-sizing: border-box; font-size: 16px; }
.title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
.subtitle { font-size: 20px; margin-bottom: 10px; text-align: center; }
.english-word { display:block; margin: 0 auto 20px; font-size: 24px; padding: 10px 20px; border-radius: 10px; background-color: #eee; text-align: center; }
.french-word { font-size: 30px; text-align: center; margin-bottom: 20px; word-spacing: 20px; }
.missing-word { width: 15px; font-size: 20px; border: none; border-bottom: 1px solid #000; background: transparent; text-align: center; margin-right: 2px; }
.correct { background-color: #cef4ce; }
.incorrect { background-color: #ffb6c19c; }
.keyboard-container { text-align: center; margin-top: 20px; }
.keyboard-button { font-size: 18px; padding: 10px 15px; margin: 2px; border: none; border-radius: 10px; background-color: #f0f0f0; color: #000; cursor: pointer; }
.keyboard-button:hover { background-color: #A9A9A9; transform: translateY(-4px); }
select { width: 20%; padding: 5px; border-radius: 10px; margin: 10px auto; height: 35px; display: block; }
.feedback { font-weight: bold; font-size: 18px; display: flex; gap: 10px; justify-content: center; align-items: center; margin-top: 10px; }
</style>
</head>
<body>
<div class="container">
 <div class="title">No vowels</div>
 <div class="subtitle">Fill in the missing vowels</div>
 <div class="english-word" id="englishWord"></div>
 <div class="french-word" id="frenchWord"></div>
 <div id="keyboardContainer" class="keyboard-container"></div>
 <select id="languageSelect">
   <option value="french" selected>French</option>
   <option value="german">German</option>
   <option value="spanish">Spanish</option>
 </select>
 <div id="feedback" class="feedback" style="display:none;">
   <span>Correct ✅</span>
   </div>
</div>

<script>
let lastFocusedInput = null;
let currentFrenchSentence = ''; // Holds the single French sentence for validation

const vowels = ['a','e','i','o','u','à','â','ä','é','è','ê','ë','î','ï','ô','ö','ù','ü','û','á','é','í','ó','ú'];

const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');

if (!sheetUrl) {
    document.getElementById('englishWord').textContent = "⚠️ No sheet URL provided in the address bar.";
}

Papa.parse(sheetUrl, {
    download: true,
    header: false, // Treat the sheet as a grid, not a table
    skipEmptyLines: false, // Preserve row indices to find the correct cells
    complete: function(results) {
        try {
            // Access data by coordinates: results.data[rowIndex][columnIndex]
            // Cell G2 is at row index 1, column index 6
            const frenchText = results.data[1][6];
            // Cell G5 is at row index 4, column index 6
            const englishText = results.data[4][6];

            if (frenchText && englishText) {
                currentFrenchSentence = frenchText.trim();
                generateExercise(currentFrenchSentence, englishText.trim());
                generateKeyboard('french');
            } else {
                throw new Error("Text not found in cells I2 or I5.");
            }
        } catch (e) {
            console.error(e);
            document.getElementById('englishWord').textContent = "⚠️ Error: Could not find text. Please check that your sheet is published and has text in cells G2 and G5.";
        }
    },
    error: function(err) {
        console.error(err);
        document.getElementById('englishWord').textContent = "⚠️ CSV load error: " + err.message;
    }
});

function generateExercise(frenchSentence, englishSentence) {
    document.getElementById('englishWord').textContent = englishSentence;
    const wordDiv = document.getElementById('frenchWord');
    wordDiv.innerHTML = "";

    for (let i = 0; i < frenchSentence.length; i++) {
        const char = frenchSentence[i];
        if (vowels.includes(char.toLowerCase())) {
            const input = document.createElement('input');
            input.type = 'text';
            input.maxLength = 1;
            input.className = 'missing-word';
            input.dataset.index = i;
            input.addEventListener('input', validateInput);
            input.addEventListener('focus', () => { lastFocusedInput = input; });
            input.addEventListener('keydown', handleBackspace);
            wordDiv.appendChild(input);
        } else {
            const span = document.createElement('span');
            span.textContent = char;
            wordDiv.appendChild(span);
        }
    }
    document.getElementById('feedback').style.display = "none";
}

function validateInput(e) {
    const input = e.target;
    // Use the stored sentence for validation
    const correctChar = currentFrenchSentence[input.dataset.index].toLowerCase();

    if (input.value.toLowerCase() === correctChar) {
        input.classList.add('correct');
        input.classList.remove('incorrect');
    } else {
        input.classList.add('incorrect');
        input.classList.remove('correct');
    }

    if (input.value.length === 1) {
        let nextInput = input.nextElementSibling;
        while (nextInput && !nextInput.classList.contains('missing-word')) {
            nextInput = nextInput.nextElementSibling;
        }
        if (nextInput) { nextInput.focus(); }
    }

    const allInputs = document.querySelectorAll('.missing-word');
    const allCorrect = Array.from(allInputs).every(inp => inp.classList.contains('correct'));

    if (allCorrect) {
        document.getElementById('feedback').style.display = "flex";
    }
}

function handleBackspace(e) {
    if (e.key === "Backspace") {
        e.preventDefault();
        const input = e.target;
        input.value = '';
        input.classList.remove('correct', 'incorrect');

        let prevInput = input.previousElementSibling;
        while (prevInput && !prevInput.classList.contains('missing-word')) {
            prevInput = prevInput.previousElementSibling;
        }
        if (prevInput) {
            prevInput.focus();
            prevInput.value = '';
            prevInput.classList.remove('correct', 'incorrect');
        }
    }
}

function generateKeyboard(language) {
    const container = document.getElementById('keyboardContainer');
    container.innerHTML = '';
    let chars = [];
    switch (language) {
        case 'french': chars = ['à', 'â', 'ä', 'é', 'è', 'ê', 'ë', 'î', 'ï', 'ô', 'ö', 'ù', 'ü', 'û', 'ç']; break;
        case 'german': chars = ['ä', 'ö', 'ü', 'ß']; break;
        case 'spanish': chars = ['á', 'é', 'í', 'ó', 'ú', 'ñ']; break;
    }
    chars.forEach(c => {
        const btn = document.createElement('button');
        btn.textContent = c;
        btn.className = 'keyboard-button';
        btn.type = 'button';
        btn.onclick = () => {
            if (lastFocusedInput) {
                const pos = lastFocusedInput.selectionStart;
                const val = lastFocusedInput.value;
                lastFocusedInput.value = val.slice(0, pos) + c + val.slice(pos);
                lastFocusedInput.setSelectionRange(pos + 1, pos + 1);
                lastFocusedInput.focus();
                lastFocusedInput.dispatchEvent(new Event('input'));
            }
        };
        container.appendChild(btn);
    });
}

document.getElementById('languageSelect').addEventListener('change', (e) => {
    generateKeyboard(e.target.value);
});
</script>
</body>
</html>
