<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Speedator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #exercise-container {
            margin: 0 auto;
            padding: 20px;
        }
        #title {
            font-size: 40px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
        }
        .subtitle {
            font-size: 16px;
            margin-bottom: 10px;
            text-align: center;
        }
        .english-text-box {
            margin-bottom: 20px;
            padding: 10px;
            font-size: 20px;
            text-align: justify;
            border: 2px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #choices-container {
            margin-bottom: 20px;
            text-align: center;
        }
        button {
            padding: 10px 15px;
            margin: 5px;
            background-color: #f9f9f9;
            color: #000000;
            border: 2px solid #ccc;
            border-radius: 10px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #A9A9A9;
            transform: translateY(-4px);
        }
        .choice {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 10px;
            font-size: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            cursor: pointer;
            background-color: #fff;
        }
        .choice:hover {
            background-color: #f0f0f0;
        }
        #dropbox-container {
            margin-bottom: 20px;
            font-size: 20px;
            line-height: 1.8;
        }
        .dropped-chunk {
            display: inline-block;
            padding: 5px 10px;
            margin-right: 10px;
            font-size: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #dff0d8;
        }
        .feedback-message {
            margin-top: 10px;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        .heart {
            color: red;
            font-size: 24px;
            margin-right: 5px;
        }
        .hide {
            display: none;
        }
        #lives, #timer {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div id="exercise-container">
        <div id="title">Speedator</div>
        <div class="subtitle" id="subtitle">Recompose the text before you run out of time or lives.</div>
        <br>
        
        <div class="english-text-box hide" id="englishText"></div>
        <div id="frenchText" class="hide"></div>

        <div id="choices-container"></div>
        <div id="dropbox-container"></div>
        <div id="lives">Lives: <span id="heart-container"></span></div>
        <div id="timer">Time Left: 10</div>
        
        <div style="text-align:center;">
             <button id="reset-btn" style="display: none;">Reset</button>
        </div>
    </div>   

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const choicesContainer = document.getElementById('choices-container');
        const dropboxContainer = document.getElementById('dropbox-container');
        const resetBtn = document.getElementById('reset-btn');
        const livesDisplay = document.getElementById('lives');
        const heartContainer = document.getElementById('heart-container');
        const timerDisplay = document.getElementById('timer');
        const englishTextBox = document.getElementById('englishText');
        const frenchTextBox = document.getElementById('frenchText');
        const subtitle = document.getElementById('subtitle');

        let frenchText = "";
        let englishText = "";
        let chunks = [];
        let correctChunks = [];
        let droppedChunks = [];
        let currentIndex = 0;
        let exerciseCompleted = false;
        let lives = 3;
        let timer;

        // --- NEW: DATA LOADING FROM GOOGLE SHEET ---
        const params = new URLSearchParams(window.location.search);
        const sheetUrl = params.get('sheet');

        if (!sheetUrl) {
            subtitle.textContent = "⚠️ No CSV URL provided. Please add ?sheet=YOUR_LINK to the address bar.";
        } else {
            subtitle.textContent = "Loading data...";
            Papa.parse(sheetUrl, {
                download: true,
                header: false, // Treat data as a grid
                skipEmptyLines: false,
                complete: function(results) {
                    try {
                        frenchText = results.data[1][6]; // Cell I2
                        englishText = results.data[4][6]; // Cell I5
                        if (!frenchText || !englishText) {
                            throw new Error("Text is missing from cell I2 or I5.");
                        }
                        
                        // Populate the divs with the loaded text
                        englishTextBox.textContent = englishText;
                        frenchTextBox.textContent = frenchText;

                        // --- AUTO-START GAME LOGIC ---
                        subtitle.textContent = "Recompose the text before you run out of time or lives.";
                        englishTextBox.classList.remove('hide');
                        
                        // Start the game automatically
                        startGame();

                    } catch (e) {
                        subtitle.textContent = "⚠️ Error reading data. Check sheet has text in G2 & G5.";
                        console.error(e);
                    }
                },
                error: function(err) {
                    subtitle.textContent = "⚠️ Error loading the CSV file.";
                    console.error(err);
                }
            });
        }
        
        function startGame(){
            resetExerciseState(); // Reset variables without touching UI
            generateChunks(frenchText);
            correctChunks = [...chunks];
            displayChoices();
        }

        function generateChunks(text) {
            const words = text.split(' ');
            chunks = [];
            const chunkLength = 4; // Set chunk length to 4
            for (let i = 0; i < words.length; i += chunkLength) {
                chunks.push(words.slice(i, i + chunkLength).join(' '));
            }
        }

        function displayChoices() {
            choicesContainer.innerHTML = '';
            if (currentIndex >= correctChunks.length) return;

            let wrongChoicesPool = chunks.filter(chunk => chunk !== correctChunks[currentIndex]);
            let shuffledWrongChoices = shuffle(wrongChoicesPool).slice(0, 3);
            let finalChoices = shuffle([correctChunks[currentIndex], ...shuffledWrongChoices]);

            finalChoices.forEach(chunk => {
                const choiceElement = createChoiceElement(chunk);
                choicesContainer.appendChild(choiceElement);
            });
            startTimer();
        }

        function createChoiceElement(chunk) {
            const choiceElement = document.createElement('div');
            choiceElement.classList.add('choice');
            choiceElement.textContent = chunk;
            choiceElement.addEventListener('click', function() {
                if (exerciseCompleted) return;
                
                clearTimeout(timer);

                if (choiceElement.textContent === correctChunks[currentIndex]) {
                    droppedChunks.push(choiceElement.textContent);
                    displayDroppedChunks();
                    currentIndex++;
                    
                    if (currentIndex >= correctChunks.length) {
                        exerciseCompleted = true;
                        displayWinningFeedback();
                        resetBtn.style.display = 'inline-block';
                        clearInterval(timer);
                    } else {
                        displayChoices();
                    }
                } else {
                    choiceElement.style.backgroundColor = '#f8d7da'; // Flash red
                    setTimeout(() => {
                        choiceElement.style.backgroundColor = '#fff';
                    }, 500);
                    lives--;
                    updateLivesDisplay();
                    if (lives === 0) {
                        gameOver();
                    } else {
                        startTimer(); // Restart timer after wrong choice
                    }
                }
            });
            return choiceElement;
        }

        function disableChoices() {
            choicesContainer.innerHTML = '<p style="color: red; font-weight: bold;">Game Over</p>';
        }

        function displayDroppedChunks() {
            dropboxContainer.innerHTML = droppedChunks.join(' ');
        }

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startTimer() {
            clearTimeout(timer);
            let timeLeft = 10;
            timerDisplay.textContent = `Time Left: ${timeLeft}`;
            timer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Time Left: ${timeLeft}`;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    lives--;
                    updateLivesDisplay();
                    if (lives === 0) {
                        gameOver();
                    } else {
                        displayChoices(); // Next set of choices
                    }
                }
            }, 1000);
        }

        function updateLivesDisplay() {
            heartContainer.innerHTML = '';
            for (let i = 0; i < lives; i++) {
                const heartIcon = document.createElement('span');
                heartIcon.classList.add('heart');
                heartIcon.innerHTML = '&#x2764;';
                heartContainer.appendChild(heartIcon);
            }
        }

        function gameOver() {
            clearInterval(timer);
            exerciseCompleted = true;
            alert('Game over! You ran out of lives.');
            disableChoices();
            resetBtn.style.display = 'inline-block';
        }

        function displayWinningFeedback() {
            const feedbackMessage = document.createElement('div');
            feedbackMessage.textContent = 'Congratulations! You completed the exercise.';
            feedbackMessage.classList.add('feedback-message');
            dropboxContainer.appendChild(feedbackMessage);
        }

        function resetExerciseState() {
            exerciseCompleted = false;
            currentIndex = 0;
            lives = 3;
            droppedChunks = [];
            dropboxContainer.innerHTML = '';
            clearTimeout(timer);
            updateLivesDisplay();
            timerDisplay.textContent = 'Time Left: 10';
            resetBtn.style.display = 'none';
        }
        
        resetBtn.addEventListener('click', startGame);
        updateLivesDisplay(); // Display initial lives count
    });
</script>
</body>
</html>
