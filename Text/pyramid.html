<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pyramid</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5; /* Light grey */
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      margin: 0;
    }
    .container {
      width: 90%;
      max-width: 1200px;
      padding: 40px;
      box-sizing: border-box;
      background-color: white;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    #title {
      font-size: 40px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }
    .subtitle {
      font-size: 20px;
      margin-bottom: 10px;
      text-align: center;
    }
    #text-container {
      margin-bottom: 20px;
      text-align: justify;
      padding: 10px;
      font-size: 20px;
      border: 2px solid #ccc;
      border-radius: 5px;
      background-color: #f9f9f9;
    }
    #choices-container {
      margin-bottom: 20px;
      text-align: center;
    }
    button {
      padding: 10px 15px;
      margin: 2px;
      background-color: #f9f9f9;
      color: #000000;
      border: 2px solid #ccc;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
    }
    button:hover {
      background-color: #A9A9A9;
      transform: translateY(-4px);
    }
    .choice {
      display: inline-block;
      padding: 5px 10px;
      margin: 5px;
      font-size: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      cursor: pointer;
      background-color: #fff;
    }
    .choice:hover {
      background-color: #f0f0f0;
    }
    #dropbox-container {
      margin-bottom: 20px;
      font-size: 20px;
      line-height: 1.8;
    }
    .dropped-chunk {
      display: inline-block;
      padding: 5px 10px;
      margin-right: 10px;
      font-size: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #dff0d8;
    }
    #chunk-length {
      width: auto;
      padding: 5px;
      border-radius: 10px;
      margin-left: 10px;
      height: 35px;
      font-size: 14px;
    }
    .controls-container {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #feedback {
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-top: 20px;
      color: green;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="title">Pyramid</div>
    <div class="subtitle" id="subtitle">One in four: Reconstruct the text by choosing the correct chunk.</div>
    <br>
    <div id="text-container" style="display: none;"></div>
    <div id="dropbox-container"></div>
    <div id="choices-container"></div>

    <div id="feedback">üéâ Congratulations! You completed the exercise.</div>

    <div class="controls-container">
      <label for="chunk-length">Select chunk length:</label>
      <select id="chunk-length">
        <option value="1">Single words</option>
        <option value="2">Small chunks</option>
        <option value="4">Medium chunks</option>
        <option value="6">Big chunks</option>
      </select>
      <button id="reset-btn" style="display: none;">Reset</button>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const textContainer = document.getElementById('text-container');
      const choicesContainer = document.getElementById('choices-container');
      const dropboxContainer = document.getElementById('dropbox-container');
      const resetBtn = document.getElementById('reset-btn');
      const chunkLengthSelect = document.getElementById('chunk-length');
      const subtitle = document.getElementById('subtitle');
      const feedback = document.getElementById('feedback');

      let englishText = "";
      let frenchText = "";
      let chunks = [];
      let correctChunks = [];
      let droppedChunks = [];
      let currentIndex = 0;
      let exerciseCompleted = false;

      const params = new URLSearchParams(window.location.search);
      const sheetUrl = params.get('sheet');

      if (!sheetUrl) {
        subtitle.textContent = "‚ö†Ô∏è No CSV URL provided. Please add ?sheet=YOUR_LINK to the address bar.";
      } else {
        subtitle.textContent = "Loading data...";
        Papa.parse(sheetUrl, {
          download: true,
          header: false,
          skipEmptyLines: false,
          complete: function(results) {
            try {
              frenchText = results.data[1][8]; // I2
              englishText = results.data[4][8]; // I5
              if (!frenchText || !englishText) throw new Error("Missing I2 or I5.");
              subtitle.textContent = "One in four: Reconstruct the text by choosing the correct chunk.";
              textContainer.textContent = englishText;
              textContainer.style.display = 'block';
              startExercise();
            } catch (e) {
              subtitle.textContent = "‚ö†Ô∏è Error reading data. Check sheet has text in I2 & I5.";
              console.error(e);
            }
          },
          error: function(err) {
            subtitle.textContent = "‚ö†Ô∏è Error loading the CSV file.";
            console.error(err);
          }
        });
      }

      function startExercise() {
        const chunkLength = parseInt(chunkLengthSelect.value);
        generateChunks(frenchText, chunkLength);
        correctChunks = [...chunks];
        droppedChunks = [];
        currentIndex = 0;
        exerciseCompleted = false;
        dropboxContainer.innerHTML = '';
        choicesContainer.style.display = 'block';
        resetBtn.style.display = 'none';
        feedback.style.display = 'none'; // ‚úÖ hide old message
        displayChoices();
      }

      function generateChunks(text, length) {
        const words = text.split(' ');
        chunks = [];
        for (let i = 0; i < words.length; i += length) {
          chunks.push(words.slice(i, i + length).join(' '));
        }
      }

      function displayChoices() {
        choicesContainer.innerHTML = '';
        if (currentIndex >= correctChunks.length) return;
        let wrongChoicesPool = chunks.filter(chunk => chunk !== correctChunks[currentIndex]);
        let shuffledWrongChoices = shuffle(wrongChoicesPool).slice(0, 3);
        let finalChoices = shuffle([correctChunks[currentIndex], ...shuffledWrongChoices]);
        finalChoices.forEach(chunk => {
          const choiceElement = createChoiceElement(chunk);
          choicesContainer.appendChild(choiceElement);
        });
      }

      function createChoiceElement(chunk) {
        const choiceElement = document.createElement('div');
        choiceElement.classList.add('choice');
        choiceElement.textContent = chunk;
        choiceElement.addEventListener('click', function() {
          if (exerciseCompleted) return;
          if (choiceElement.textContent === correctChunks[currentIndex]) {
            droppedChunks.push(choiceElement.textContent);
            displayDroppedChunks();
            currentIndex++;
            if (currentIndex >= correctChunks.length) {
              exerciseCompleted = true;
              feedback.style.display = 'block'; // ‚úÖ show congratulation
              choicesContainer.style.display = 'none';
              resetBtn.style.display = 'inline-block';
            } else {
              displayChoices();
            }
          } else {
            choiceElement.style.backgroundColor = '#f8d7da';
            setTimeout(() => { choiceElement.style.backgroundColor = '#fff'; }, 500);
          }
        });
        return choiceElement;
      }

      function displayDroppedChunks() {
        dropboxContainer.innerHTML = droppedChunks.join(' ');
      }

      function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      chunkLengthSelect.addEventListener('change', startExercise);
      resetBtn.addEventListener('click', startExercise);
    });
  </script>
</body>
</html>
