<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>No vowels - Vocab</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
body { font-family: Arial, sans-serif; }
.container { width: 100%; padding: 20px; box-sizing: border-box; font-size: 16px; }
.title { font-size: 40px; font-weight: bold; text-align: center; margin-bottom: 20px; }
.subtitle { font-size: 20px; margin-bottom: 10px; text-align:center; }
.counter { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 10px; }
textarea { width: 100%; height: 150px; font-size: 20px; margin-bottom: 10px; border-radius: 5px; }
button { padding: 10px 20px; background-color: #f9f9f9; border: 2px solid #ccc; color: #000000; border-radius: 10px; cursor: pointer; }
button:hover { background-color: #A9A9A9; transform: translateY(-4px); }
.hide { display: none; }
.missing-word { width: 15px; padding:0; font-size:20px; border:none; border-bottom:0.5px solid #000; background-color:transparent; outline:none; margin-right:2px; text-align:center; }
.correct { background-color: #cef4ce; }
.incorrect { background-color: #ffb6c19c; }
#keyboardContainer { text-align:center; margin-top:20px; }
.keyboard-button { font-size: 18px; padding: 10px 15px; margin:2px; border:none; border-radius:10px; background-color:#10148; color:#000; box-shadow:0 4px 8px rgba(0,0,0,0.3); }
.keyboard-button:hover { background-color:#A9A9A9; transform: translateY(-4px); }
select { width: 20%; padding:5px; border-radius:10px; margin-bottom:10px; height:35px; }
</style>
</head>
<body>
<div class="container">
  <div class="title">No vowels</div>
  <div class="subtitle" id="subtitle">Fill in the French word with the correct vowels: Click "Generate Exercise"</div>
  <div class="counter" id="sentenceCounter"></div>

  <div id="exerciseOutput"></div>
  <div class="input-container">
    <button id="generateButtonChunk" onclick="generateChunk()">Generate Exercise</button>
    <select id="languageSelect" onchange="generateKeyboard(this.value)">
      <option value="french" selected>French</option>
      <option value="german">German</option>
      <option value="spanish">Spanish</option>
    </select>
    <div id="feedback" class="hide"></div>
    <button id="resetButton" class="hide" onclick="resetActivity()">Restart</button>
    <button id="nextButton" class="hide" onclick="nextText()">Next</button>
    <div id="keyboardContainer"></div>
  </div>
</div>

<script>
var currentTextIndex = 0;
var sentencePairs = [];
var lastFocusedInput = null;
var vowels = ['a','e','i','o','u','à','â','ä','é','è','ê','ë','î','ï','ô','ö','ù','ü','û','á','é','í','ó','ú'];

// Get spreadsheet URL from query parameter
const params = new URLSearchParams(window.location.search);
const sheetUrl = params.get('sheet');
if(!sheetUrl){ alert('No spreadsheet URL provided'); }

// Load vocab list from columns A (French) and B (English)
Papa.parse(sheetUrl, {
    download: true,
    header: true,        // Important: use headers
    skipEmptyLines: true,
    complete: function(results) {
        results.data.forEach(row => {
            if (row.French && row.English) {
                sentencePairs.push({
                    french: row.French.trim(),
                    english: row.English.trim()
                });
            }
        });

        if (sentencePairs.length === 0) {
            alert("No items found in columns French and English!");
            return;
        }

        shuffleArray(sentencePairs);
        document.getElementById('generateButtonChunk').classList.remove('hide');
    },
    error: function(err) {
        console.error(err);
        alert("CSV load error");
    }
});


function insertCharacter(character) {
  if(lastFocusedInput){
    var cursorPosition = lastFocusedInput.selectionStart;
    var currentValue = lastFocusedInput.value;
    lastFocusedInput.value = currentValue.slice(0,cursorPosition)+character+currentValue.slice(cursorPosition);
    lastFocusedInput.setSelectionRange(cursorPosition+1,cursorPosition+1);
    validateCharacter(lastFocusedInput);
  }
}

function generateKeyboard(language){
  var keyboardContainer = document.getElementById('keyboardContainer');
  keyboardContainer.innerHTML = '';
  var characters = [];
  switch(language){
    case 'german': characters=['ä','ö','ü','ß']; break;
    case 'french': characters=['à','â','ä','é','è','ê','ë','î','ï','ô','ö','ù','ü','û','ç']; break;
    case 'spanish': characters=['á','é','í','ó','ú','ñ']; break;
  }
  characters.forEach(function(character){
    var button = document.createElement('button');
    button.innerHTML = character;
    button.className='keyboard-button';
    button.addEventListener('click',function(e){ e.preventDefault(); insertCharacter(character); });
    keyboardContainer.appendChild(button);
  });
}

function setLastFocusedInput(input){ lastFocusedInput = input; }

function generateChunk(){
  var englishSentence = sentencePairs[currentTextIndex].english;
  var frenchSentence = sentencePairs[currentTextIndex].french;

  var sentenceWithInputFields = '';
  for(var i=0;i<frenchSentence.length;i++){
    var char = frenchSentence[i];
    if(vowels.includes(char.toLowerCase())){
      sentenceWithInputFields += `<input type="text" class="missing-word" data-index="${i}" oninput="validateCharacter(this)" onfocus="setLastFocusedInput(this)" onkeydown="submitOnEnter(event,this)">`;
    } else { sentenceWithInputFields += char; }
  }

  var exerciseOutput = document.getElementById('exerciseOutput');
  exerciseOutput.innerHTML = `<div class="english-sentence">${englishSentence}</div><div class="french-sentence">${sentenceWithInputFields}</div>`;
  exerciseOutput.classList.remove('hide');
  document.getElementById('feedback').classList.add('hide');
  document.getElementById('resetButton').classList.add('hide');
  document.getElementById('nextButton').classList.add('hide');
  document.getElementById('sentenceCounter').textContent = (currentTextIndex+1)+' / '+sentencePairs.length;
}

function validateCharacter(input){
  var userInput = input.value.trim().toLowerCase();
  if(userInput===''){ input.classList.remove('correct','incorrect'); return; }
  var correctChar = sentencePairs[currentTextIndex].french[input.getAttribute('data-index')];
  if(userInput===correctChar.toLowerCase()){ input.classList.add('correct'); input.classList.remove('incorrect'); }
  else{ input.classList.add('incorrect'); input.classList.remove('correct'); }

  // focus next input
  var nextInput = input.nextElementSibling;
  if(nextInput && nextInput.classList.contains('missing-word')) nextInput.focus();

  checkAnswers();
}

function checkAnswers(){
  var allCorrect=true;
  document.querySelectorAll('.missing-word').forEach(input=>{
    if(!input.classList.contains('correct')) allCorrect=false;
  });
  if(allCorrect){
    if(currentTextIndex===sentencePairs.length-1) document.getElementById('resetButton').classList.remove('hide');
    else document.getElementById('nextButton').classList.remove('hide');
  }
}

function submitOnEnter(event,input){
  if(event.keyCode===13){ jumpToNextInput(input); event.preventDefault(); }
  else if(event.keyCode===8 && input.value===''){ jumpToPreviousInput(input); event.preventDefault(); }
}

function jumpToNextInput(input){
  var nextInput=input.nextElementSibling;
  if(nextInput && nextInput.classList.contains('missing-word')) nextInput.focus();
}

function jumpToPreviousInput(input){
  var prevInput=input.previousElementSibling;
  if(prevInput && prevInput.classList.contains('missing-word')){
    prevInput.focus();
    prevInput.value='';
    prevInput.classList.remove('correct','incorrect');
  }
}

function resetActivity(){
  currentTextIndex=0;
  sentencePairs.sort(()=>Math.random()-0.5); // shuffle
  generateChunk();
}

function nextText(){
  currentTextIndex = (currentTextIndex+1)%sentencePairs.length;
  generateChunk();
}

window.onload = function(){
  generateKeyboard('french');
};
</script>
</body>
</html>
